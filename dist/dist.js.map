{"version":3,"sources":["../src/componentManager.js"],"names":["ComponentManager","permissions","onReady","sentMessages","messageQueue","initialPermissions","loggingEnabled","acceptsThemes","onReadyCallback","coallesedSaving","coallesedSavingDelay","messageHandler","event","mobileSource","console","log","data","origin","JSON","parse","handleMessage","document","addEventListener","window","payload","action","sessionKey","componentData","activateThemes","themes","original","originalMessage","filter","message","messageId","alert","callback","length","requestPermissions","postMessage","environment","platform","uuid","key","value","push","generateUUID","api","sentMessage","stringify","parent","type","width","height","bind","contentTypes","Array","isArray","content_types","items","item","jsonObjectForItem","associateItem","mapped","map","content_type","deleteItems","params","skipDebouncer","saveItems","presave","saveItemsWithPresave","saveBlock","mappedItems","updated_at","Date","pendingSave","clearTimeout","setTimeout","copy","Object","assign","children","AppDomain","content","appData","urls","deactivateAllCustomThemes","url","link","createElement","href","rel","media","className","getElementsByTagName","appendChild","elements","from","getElementsByClassName","slice","element","disabled","parentNode","removeChild","crypto","msCrypto","buf","Uint32Array","getRandomValues","idx","replace","c","r","v","toString","d","getTime","performance","now","Math","random","floor","module","exports"],"mappings":"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","file":"dist.js","sourcesContent":["class ComponentManager {\n\n  constructor(permissions, onReady) {\n    this.sentMessages = [];\n    this.messageQueue = [];\n    this.initialPermissions = permissions;\n    this.loggingEnabled = false;\n    this.acceptsThemes = true;\n    this.onReadyCallback = onReady;\n\n    this.coallesedSaving = true;\n    this.coallesedSavingDelay = 250;\n\n    let messageHandler = (event, mobileSource) => {\n      if (this.loggingEnabled) { console.log(\"Components API Message received:\", event.data, \"mobile?\", mobileSource)}\n\n      // The first message will be the most reliable one, so we won't change it after any subsequent events,\n      // in case you receive an event from another window.\n      if(!this.origin) {\n        this.origin = event.origin;\n      }\n      this.mobileSource = mobileSource;\n      // If from mobile app, JSON needs to be used.\n      let data = mobileSource ? JSON.parse(event.data) : event.data;\n      this.handleMessage(data);\n    }\n\n    // Mobile (React Native) uses `document`, web/desktop uses `window`.addEventListener\n    // for postMessage API to work properly.\n\n    document.addEventListener(\"message\", function (event) {\n      messageHandler(event, true);\n    }, false);\n\n    window.addEventListener(\"message\", function (event) {\n      messageHandler(event, false);\n    }, false);\n  }\n\n  handleMessage(payload) {\n    if(payload.action === \"component-registered\") {\n      this.sessionKey = payload.sessionKey;\n      this.componentData = payload.componentData;\n      this.onReady(payload.data);\n\n      if(this.loggingEnabled) {\n        console.log(\"Component successfully registered with payload:\", payload);\n      }\n\n    } else if(payload.action === \"themes\") {\n      if(this.acceptsThemes) {\n        this.activateThemes(payload.data.themes);\n      }\n    }\n\n    else if(payload.original) {\n      // get callback from queue\n      var originalMessage = this.sentMessages.filter(function(message){\n        return message.messageId === payload.original.messageId;\n      })[0];\n\n      if(!originalMessage) {\n        // Connection must have been reset. Alert the user.\n        alert(\"This extension is attempting to communicate with Standard Notes, but an error is preventing it from doing so. Please restart this extension and try again.\")\n      }\n\n      if(originalMessage.callback) {\n        originalMessage.callback(payload.data);\n      }\n    }\n  }\n\n  onReady(data) {\n    if(this.initialPermissions && this.initialPermissions.length > 0) {\n      this.requestPermissions(this.initialPermissions);\n    }\n\n    for(var message of this.messageQueue) {\n      this.postMessage(message.action, message.data, message.callback);\n    }\n\n    this.messageQueue = [];\n    this.environment = data.environment;\n    this.platform = data.platform;\n    this.uuid = data.uuid;\n\n    if(this.onReadyCallback) {\n      this.onReadyCallback();\n    }\n  }\n\n  getSelfComponentUUID() {\n    return this.uuid;\n  }\n\n  isRunningInDesktopApplication() {\n    return this.environment === \"desktop\";\n  }\n\n  setComponentDataValueForKey(key, value) {\n    this.componentData[key] = value;\n    this.postMessage(\"set-component-data\", {componentData: this.componentData}, function(data){});\n  }\n\n  clearComponentData() {\n    this.componentData = {};\n    this.postMessage(\"set-component-data\", {componentData: this.componentData}, function(data){});\n  }\n\n  componentDataValueForKey(key) {\n    return this.componentData[key];\n  }\n\n  postMessage(action, data, callback) {\n    if(!this.sessionKey) {\n      this.messageQueue.push({\n        action: action,\n        data: data,\n        callback: callback\n      });\n      return;\n    }\n\n    var message = {\n      action: action,\n      data: data,\n      messageId: this.generateUUID(),\n      sessionKey: this.sessionKey,\n      api: \"component\"\n    }\n\n    var sentMessage = JSON.parse(JSON.stringify(message));\n    sentMessage.callback = callback;\n    this.sentMessages.push(sentMessage);\n\n    // Mobile (React Native) requires a string for the postMessage API.\n    if(this.mobileSource) {\n      message = JSON.stringify(message);\n    }\n\n    if(this.loggingEnabled) {\n      console.log(\"Posting message:\", message);\n    }\n\n    window.parent.postMessage(message, this.origin);\n  }\n\n  setSize(type, width, height) {\n    this.postMessage(\"set-size\", {type: type, width: width, height: height}, function(data){\n\n    })\n  }\n\n  requestPermissions(permissions, callback) {\n    this.postMessage(\"request-permissions\", {permissions: permissions}, function(data){\n      callback && callback();\n    }.bind(this));\n  }\n\n  streamItems(contentTypes, callback) {\n    if(!Array.isArray(contentTypes)) {\n      contentTypes = [contentTypes];\n    }\n    this.postMessage(\"stream-items\", {content_types: contentTypes}, function(data){\n      callback(data.items);\n    }.bind(this));\n  }\n\n  streamContextItem(callback) {\n    this.postMessage(\"stream-context-item\", null, (data) => {\n      var item = data.item;\n      /*\n        When an item is saved via saveItem, its updated_at value is set client side to the current date.\n        If we make a change locally, then for whatever reason receive an item via streamItems/streamContextItem,\n        we want to ignore that change if it was made prior to the latest change we've made.\n\n        Update 1/22/18: However, if a user is restoring a note from version history, this change\n        will not pass through this filter and will thus be ignored. Because the client now handles\n        this case with isMetadataUpdate, we no longer need the below.\n      */\n      // if(this.streamedContextItem && this.streamedContextItem.uuid == item.uuid\n      //   && this.streamedContextItem.updated_at > item.updated_at) {\n      //   return;\n      // }\n      // this.streamedContextItem = item;\n      callback(item);\n    });\n  }\n\n  selectItem(item) {\n    this.postMessage(\"select-item\", {item: this.jsonObjectForItem(item)});\n  }\n\n  createItem(item, callback) {\n    this.postMessage(\"create-item\", {item: this.jsonObjectForItem(item)}, function(data){\n      var item = data.item;\n\n      // A previous version of the SN app had an issue where the item in the reply to create-item\n      // would be nested inside \"items\" and not \"item\". So handle both cases here.\n      if(!item && data.items && data.items.length > 0) {\n        item = data.items[0];\n      }\n\n      this.associateItem(item);\n      callback && callback(item);\n    }.bind(this));\n  }\n\n  createItems(items, callback) {\n    let mapped = items.map((item) => {return this.jsonObjectForItem(item)});\n    this.postMessage(\"create-items\", {items: mapped}, function(data){\n      callback && callback(data.items);\n    }.bind(this));\n  }\n\n  associateItem(item) {\n    this.postMessage(\"associate-item\", {item: this.jsonObjectForItem(item)});\n  }\n\n  deassociateItem(item) {\n    this.postMessage(\"deassociate-item\", {item: this.jsonObjectForItem(item)});\n  }\n\n  clearSelection() {\n    this.postMessage(\"clear-selection\", {content_type: \"Tag\"});\n  }\n\n  deleteItem(item, callback) {\n    this.deleteItems([item], callback);\n  }\n\n  deleteItems(items, callback) {\n    var params = {\n      items: items.map(function(item){\n        return this.jsonObjectForItem(item);\n      }.bind(this))\n    };\n\n    this.postMessage(\"delete-items\", params, (data) => {\n      callback && callback(data);\n    });\n  }\n\n  sendCustomEvent(action, data, callback) {\n    this.postMessage(action, data, function(data){\n      callback && callback(data);\n    }.bind(this));\n  }\n\n  saveItem(item, callback, skipDebouncer = false) {\n    this.saveItems([item], callback, skipDebouncer);\n  }\n\n  /* Presave allows clients to perform any actions last second before the save actually occurs (like setting previews).\n     Saves debounce by default, so if a client needs to compute a property on an item before saving, it's best to\n     hook into the debounce cycle so that clients don't have to implement their own debouncing.\n   */\n\n  saveItemWithPresave(item, presave, callback) {\n    this.saveItemsWithPresave([item], presave, callback);\n  }\n\n  saveItemsWithPresave(items, presave, callback) {\n    this.saveItems(items, callback, false, presave);\n  }\n\n  /*\n  skipDebouncer allows saves to go through right away rather than waiting for timeout.\n  This should be used when saving items via other means besides keystrokes.\n   */\n  saveItems(items, callback, skipDebouncer = false, presave) {\n    let saveBlock = () => {\n      // presave block allows client to gain the benefit of performing something in the debounce cycle.\n      presave && presave();\n\n      let mappedItems = items.map(function(item) {\n        item.updated_at = new Date();\n        return this.jsonObjectForItem(item);\n      }.bind(this));\n\n      this.postMessage(\"save-items\", {items: mappedItems}, function(data){\n        callback && callback();\n      });\n    }\n\n    /*\n      Coallesed saving prevents saves from being made after every keystroke, and instead\n      waits coallesedSavingDelay before performing action. For example, if a user types a keystroke, and the clienet calls saveItem,\n      a 250ms delay will begin. If they type another keystroke within 250ms, the previously pending\n      save will be cancelled, and another 250ms delay occurs. If ater 250ms the pending delay is not cleared by a future call,\n      the save will finally trigger.\n\n      Note: it's important to modify saving items updated_at immediately and not after delay. If you modify after delay,\n      a delayed sync could just be wrapping up, and will send back old data and replace what the user has typed.\n    */\n    if(this.coallesedSaving == true && !skipDebouncer) {\n      if(this.pendingSave) {\n        clearTimeout(this.pendingSave);\n      }\n\n      this.pendingSave = setTimeout(() => {\n        saveBlock();\n      }, this.coallesedSavingDelay);\n    } else {\n      saveBlock();\n    }\n  }\n\n  jsonObjectForItem(item) {\n    var copy = Object.assign({}, item);\n    copy.children = null;\n    copy.parent = null;\n    return copy;\n  }\n\n  getItemAppDataValue(item, key) {\n    let AppDomain = \"org.standardnotes.sn\";\n    var data = item.content.appData && item.content.appData[AppDomain];\n    if(data) {\n      return data[key];\n    } else {\n      return null;\n    }\n  }\n\n  /* Themes */\n\n  activateThemes(urls) {\n    this.deactivateAllCustomThemes();\n\n    if(this.loggingEnabled) {\n      console.log(\"Activating themes:\", urls);\n    }\n\n    if(!urls) {\n      return;\n    }\n\n    for(var url of urls) {\n      if(!url) {\n        continue;\n      }\n\n      var link = document.createElement(\"link\");\n      link.href = url;\n      link.type = \"text/css\";\n      link.rel = \"stylesheet\";\n      link.media = \"screen,print\";\n      link.className = \"custom-theme\";\n      document.getElementsByTagName(\"head\")[0].appendChild(link);\n    }\n  }\n\n  deactivateAllCustomThemes() {\n    // make copy, as it will be modified during loop\n    // `getElementsByClassName` is an HTMLCollection, not an Array\n    var elements = Array.from(document.getElementsByClassName(\"custom-theme\")).slice()\n    for(var element of elements) {\n      if(element) {\n        element.disabled = true;\n        element.parentNode.removeChild(element);\n      }\n    }\n  }\n\n\n  /* Utilities */\n\n\n  generateUUID() {\n    var crypto = window.crypto || window.msCrypto;\n    if(crypto) {\n      var buf = new Uint32Array(4);\n      crypto.getRandomValues(buf);\n      var idx = -1;\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n          idx++;\n          var r = (buf[idx>>3] >> ((idx%8)*4))&15;\n          var v = c == 'x' ? r : (r&0x3|0x8);\n          return v.toString(16);\n      });\n    } else {\n      var d = new Date().getTime();\n      if(window.performance && typeof window.performance.now === \"function\"){\n        d += performance.now(); //use high-precision timer if available\n      }\n      var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = (d + Math.random()*16)%16 | 0;\n        d = Math.floor(d/16);\n        return (c=='x' ? r : (r&0x3|0x8)).toString(16);\n      });\n      return uuid;\n    }\n  }\n}\n\n\nif(typeof module != \"undefined\" && typeof module.exports != \"undefined\") {\n  module.exports = ComponentManager;\n}\n\nif(window) {\n  window.ComponentManager = ComponentManager;\n}\n"]}